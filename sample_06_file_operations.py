#!/usr/bin/env python3
"""
ğŸ“ Sample 06: File Upload vÃ  Download Operations
Demo cÃ¡c thao tÃ¡c vá»›i file theo README
"""

import os
import tempfile
from pathlib import Path
from nova_act import NovaAct

def create_test_file():
    """Táº¡o file test Ä‘á»ƒ upload"""
    test_content = """# Test File for Nova Act Demo

This is a test file created for demonstrating file upload functionality.

## Content
- Line 1: Hello World
- Line 2: Nova Act Demo
- Line 3: File Upload Test

Generated by Nova Act Sample 06
"""
    
    # Táº¡o file táº¡m
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
        f.write(test_content)
        return f.name

def demo_file_upload():
    """Demo upload file"""
    
    print("ğŸ“¤ Demo File Upload")
    print("-" * 30)
    
    # Táº¡o file test
    upload_file = create_test_file()
    print(f"ğŸ“„ Táº¡o file test: {upload_file}")
    
    try:
        with NovaAct(
            starting_page="https://file.io",  # Free file upload service
            headless=False
        ) as nova:
            
            print("ğŸ” TÃ¬m file upload input...")
            nova.act("find the file upload area or input")
            
            # Sá»­ dá»¥ng Playwright Ä‘á»ƒ upload file
            print(f"ğŸ“¤ Äang upload file: {Path(upload_file).name}")
            nova.page.set_input_files('input[type="file"]', upload_file)
            
            # Chá» upload hoÃ n thÃ nh
            print("â³ Chá» upload hoÃ n thÃ nh...")
            nova.act("wait for the upload to complete")
            
            # Láº¥y link download náº¿u cÃ³
            nova.act("get the download link if available")
            
            print("âœ… Upload hoÃ n thÃ nh!")
            
    except Exception as e:
        print(f"âŒ Lá»—i upload: {e}")
    finally:
        # XÃ³a file test
        if os.path.exists(upload_file):
            os.unlink(upload_file)
            print(f"ğŸ—‘ï¸ ÄÃ£ xÃ³a file test: {upload_file}")

def demo_file_download_button():
    """Demo download file qua button"""
    
    print("\nğŸ“¥ Demo File Download (Button)")
    print("-" * 30)
    
    try:
        with NovaAct(
            starting_page="https://sample-files.com/zip/10/mp3/SampleAudio_0.4mb_mp3.zip",
            headless=False
        ) as nova:
            
            print("ğŸ” TÃ¬m download button...")
            
            # Sá»­ dá»¥ng Playwright Ä‘á»ƒ capture download
            with nova.page.expect_download() as download_info:
                nova.act("click on the download button")
            
            # Láº¥y thÃ´ng tin download
            download = download_info.value
            temp_path = download.path()
            
            print(f"ğŸ“¥ File Ä‘Ã£ download: {temp_path}")
            print(f"ğŸ“Š KÃ­ch thÆ°á»›c: {os.path.getsize(temp_path)} bytes")
            
            # LÆ°u file vÃ o vá»‹ trÃ­ mong muá»‘n
            save_path = "downloaded_sample.zip"
            download.save_as(save_path)
            
            print(f"ğŸ’¾ ÄÃ£ lÆ°u file: {save_path}")
            
            # XÃ³a file sau demo
            if os.path.exists(save_path):
                os.unlink(save_path)
                print(f"ğŸ—‘ï¸ ÄÃ£ xÃ³a file demo: {save_path}")
            
    except Exception as e:
        print(f"âŒ Lá»—i download: {e}")

def demo_page_content_download():
    """Demo download ná»™i dung trang hiá»‡n táº¡i"""
    
    print("\nğŸ“„ Demo Download Page Content")
    print("-" * 30)
    
    try:
        with NovaAct(
            starting_page="https://httpbin.org/json",  # API tráº£ vá» JSON
            headless=True
        ) as nova:
            
            print("ğŸ“– Äang láº¥y ná»™i dung trang...")
            
            # Láº¥y HTML content
            html_content = nova.page.content()
            print(f"ğŸ“ HTML content length: {len(html_content)} chars")
            
            # LÆ°u HTML
            with open("page_content.html", "w", encoding="utf-8") as f:
                f.write(html_content)
            print("ğŸ’¾ ÄÃ£ lÆ°u HTML content")
            
            # Náº¿u lÃ  PDF hoáº·c file khÃ¡c, dÃ¹ng request
            print("ğŸ“¥ Äang download content qua request...")
            response = nova.page.request.get(nova.page.url)
            
            with open("api_response.json", "wb") as f:
                f.write(response.body())
            
            print("ğŸ’¾ ÄÃ£ lÆ°u API response")
            
            # XÃ³a files demo
            for file in ["page_content.html", "api_response.json"]:
                if os.path.exists(file):
                    os.unlink(file)
                    print(f"ğŸ—‘ï¸ ÄÃ£ xÃ³a: {file}")
            
    except Exception as e:
        print(f"âŒ Lá»—i: {e}")

def demo_multiple_file_upload():
    """Demo upload nhiá»u file"""
    
    print("\nğŸ“¤ Demo Multiple File Upload")
    print("-" * 30)
    
    # Táº¡o nhiá»u file test
    test_files = []
    for i in range(3):
        content = f"Test file {i+1}\nContent for file number {i+1}"
        with tempfile.NamedTemporaryFile(mode='w', suffix=f'_test_{i+1}.txt', delete=False) as f:
            f.write(content)
            test_files.append(f.name)
    
    print(f"ğŸ“„ Táº¡o {len(test_files)} file test")
    
    try:
        with NovaAct(
            starting_page="https://file.io",
            headless=False
        ) as nova:
            
            print("ğŸ” TÃ¬m multiple file upload...")
            nova.act("find file upload input that supports multiple files")
            
            # Upload táº¥t cáº£ files
            print(f"ğŸ“¤ Äang upload {len(test_files)} files...")
            nova.page.set_input_files('input[type="file"]', test_files)
            
            # Chá» upload
            nova.act("wait for all uploads to complete")
            
            print("âœ… Multiple upload hoÃ n thÃ nh!")
            
    except Exception as e:
        print(f"âŒ Lá»—i multiple upload: {e}")
    finally:
        # XÃ³a test files
        for file in test_files:
            if os.path.exists(file):
                os.unlink(file)
        print(f"ğŸ—‘ï¸ ÄÃ£ xÃ³a {len(test_files)} file test")

def demo_drag_drop_upload():
    """Demo drag & drop upload"""
    
    print("\nğŸ–±ï¸ Demo Drag & Drop Upload")
    print("-" * 30)
    
    upload_file = create_test_file()
    
    try:
        with NovaAct(
            starting_page="https://file.io",
            headless=False
        ) as nova:
            
            print("ğŸ¯ TÃ¬m drag & drop area...")
            nova.act("find the drag and drop upload area")
            
            # Simulate drag & drop báº±ng cÃ¡ch set file input
            print("ğŸ–±ï¸ Simulate drag & drop...")
            nova.page.set_input_files('input[type="file"]', upload_file)
            
            nova.act("wait for drag and drop upload to complete")
            
            print("âœ… Drag & drop upload hoÃ n thÃ nh!")
            
    except Exception as e:
        print(f"âŒ Lá»—i drag & drop: {e}")
    finally:
        if os.path.exists(upload_file):
            os.unlink(upload_file)

def main():
    """Demo file operations"""
    
    # Kiá»ƒm tra API key
    api_key = os.getenv('NOVA_ACT_API_KEY')
    if not api_key:
        print("âŒ Vui lÃ²ng set NOVA_ACT_API_KEY")
        return
    
    print("ğŸ“ Sample 06: File Upload & Download Operations")
    print("=" * 50)
    print("ğŸ“¤ğŸ“¥ Demo cÃ¡c thao tÃ¡c vá»›i file")
    
    # Danh sÃ¡ch demos
    demos = [
        ("File Upload", demo_file_upload),
        ("File Download (Button)", demo_file_download_button),
        ("Page Content Download", demo_page_content_download),
        ("Multiple File Upload", demo_multiple_file_upload),
        ("Drag & Drop Upload", demo_drag_drop_upload)
    ]
    
    print(f"\nğŸ“‹ Sáº½ cháº¡y {len(demos)} demo:")
    for i, (name, _) in enumerate(demos, 1):
        print(f"   {i}. {name}")
    
    # Cháº¡y tá»«ng demo
    for demo_name, demo_func in demos:
        print(f"\n{'='*50}")
        print(f"ğŸ¯ {demo_name}")
        print(f"{'='*50}")
        
        try:
            demo_func()
        except KeyboardInterrupt:
            print("â¸ï¸ Demo bá»‹ dá»«ng bá»Ÿi user")
            break
        except Exception as e:
            print(f"âŒ Lá»—i trong {demo_name}: {e}")
        
        print(f"âœ… HoÃ n thÃ nh {demo_name}")
    
    print(f"\nğŸ’¡ VÃ­ dá»¥ nÃ y minh há»a:")
    print("   â€¢ nova.page.set_input_files() cho file upload")
    print("   â€¢ nova.page.expect_download() cho download capture")
    print("   â€¢ download.save_as() Ä‘á»ƒ lÆ°u file")
    print("   â€¢ nova.page.content() cho HTML content")
    print("   â€¢ nova.page.request.get() cho binary content")
    print("   â€¢ Multiple file upload")
    print("   â€¢ Drag & drop simulation")
    
    print(f"\nğŸ“ File Operations Checklist:")
    print("   âœ… Upload single file")
    print("   âœ… Upload multiple files")
    print("   âœ… Download via button click")
    print("   âœ… Download page content")
    print("   âœ… Handle different file types")
    print("   âœ… Drag & drop upload")

if __name__ == "__main__":
    main()
